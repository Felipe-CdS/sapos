<%
  text_name = options[:name]
  text_id = "widget_" + options[:id]
  value = attributes[:text] || ""
%>

<%= text_field_tag(
  text_name, value,
  id: text_id, class: "text-input", maxlength: 255, size: 30
) %>

<script>
  function search(url, set_extra) {
    let that = this;
    return function( request, response ) {
      if ( that.xhr ) {
        that.xhr.abort();
      }
      set_extra(request)

      that.xhr = $.ajax( {
        url: url,
        data: request,
        dataType: "json",
        success: function( data ) {
          response( data );
        },
        error: function() {
          response( [] );
        }
      } );
    }
  }

  $(document).ready(function() {
    $(`#<%= text_id %>`).autocomplete({
      source: search("<%= state_form_autocompletes_path %>", (request) => {
        <% if CustomVariable.identity_issuing_country %>
          request.country = "<%= CustomVariable.identity_issuing_country %>"
        <% end %>
      })
    })
  });
</script>
